@@include('./include/_head.html')

<body class="layout-light side-menu">

@@include('./include/_header_menu.html')

<main class="main-content">

    @@include('./include/_sidebar_menu.html')

    <div class="dashboard-container" id="app-content">

        <section class="dashboard-section section-map">
            <img src="img/meari-map.jpg" alt="메아리 지도">
        </section>

        <section class="dashboard-section section-list">
            <div class="sensor-list-container">
                <header class="sensor-list-header">
                    <h6>방송 목록</h6>
                    <div>
                        <div class="d-flex flex-wrap justify-content-sm-start justify-content-center">
                            <button type="button"
                                    class="broadcast-add-btn"
                            >
                                방송데이터 추가
                            </button>
                        </div>

                    </div>
                </header>

                <div class="sensor-list-body">
                    <div class="dm-collapse dm-collapse-custom">
                        <div id="broadcast-accordion-parent">

                            <!-- 센서 카드01 -->
                            <div class="dm-collapse-item mb-2">
                                <div class="dm-collapse-item__header" id="analyze-sensor-group-01">
                                    <a href="#"
                                       class="item-link analyze-sensor-wrapper broadcast-card"
                                       data-bs-toggle="collapse"
                                       data-bs-target="#collapse-body-c-1"
                                       aria-expanded="false"
                                       data-bs-parent="#broadcast-accordion-parent"
                                    >
                                        <div class="broadcast-card-content">
                                            <div class="broadcast-card-row broadcast-card-row-1">
                                            <span class="broadcast-card-status-playing">
                                                <i class="fas fa-volume-up"></i>
                                                재생중
                                            </span>
                                                <span class="broadcast-card-interval">
                                                <i class="las la-clock"></i>
                                                    0시간 05분 간격
                                            </span>
                                            </div>
                                            <div class="broadcast-card-row broadcast-card-row-2">
                                                <div>
                                                    <span class="broadcast-card-sensor-tag">
                                                    <span class="dot active"></span>
                                                    투입 1호
                                                </span>
                                                    <span class="broadcast-card-sensor-tag">
                                                    <span class="dot active"></span>
                                                    휴대 4호
                                                </span>
                                                </div>
                                                <i class="la la-angle-right"></i>
                                            </div>
                                            <div class="broadcast-card-row broadcast-card-row-3">
                                                <i class="las la-volume-down"></i>
                                                <p class="broadcast-card-message">
                                                    도움이 필요한 분 계십니까? 계시다면 소리가 나는 곳...
                                                </p>
                                            </div>
                                        </div>

                                    </a>
                                </div>

                                <div id="collapse-body-c-1" class="collapse dm-collapse-item__body">
                                    <div class="broadcast-card-controls">
                                        <button type="button" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-volume-mute"></i>
                                            <span>중단</span>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-edit"></i>
                                            <span>수정</span>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm btn-delete">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>삭제</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 센서 카드02 -->
                            <div class="dm-collapse-item mb-2">
                                <div class="dm-collapse-item__header" id="analyze-sensor-group-02">
                                    <a href="#"
                                       class="item-link analyze-sensor-wrapper broadcast-card"
                                       data-bs-toggle="collapse"
                                       data-bs-target="#collapse-body-c-2"
                                       aria-expanded="false"
                                       data-bs-parent="#broadcast-accordion-parent"
                                    >
                                        <div class="broadcast-card-content">
                                            <div class="broadcast-card-row broadcast-card-row-1">
                                            <span class="broadcast-card-status-stop">
                                                <i class="fas fa-volume-mute"></i> 중지중
                                            </span>
                                                <span class="broadcast-card-interval">
                                                <i class="las la-clock"></i> 0시간 05분 간격
                                            </span>
                                            </div>
                                            <div class="broadcast-card-row broadcast-card-row-2">
                                                <div>
                                                    <span class="broadcast-card-sensor-tag">
                                                        <span class="dot active"></span>
                                                        휴대 4호
                                                    </span>
                                                </div>
                                                <i class="la la-angle-right"></i>
                                            </div>
                                            <div class="broadcast-card-row broadcast-card-row-3">
                                                <i class="las la-volume-down"></i>
                                                <p class="broadcast-card-message">
                                                    도움이 필요한 분 계십니까? 계시다면 소리가 나는 곳...
                                                </p>
                                            </div>
                                        </div>

                                    </a>
                                </div>

                                <div id="collapse-body-c-2" class="collapse dm-collapse-item__body">
                                    <div class="broadcast-card-controls">
                                        <button type="button" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-volume-mute"></i>
                                            <span>중단</span>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-edit"></i>
                                            <span>수정</span>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm btn-delete">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>삭제</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 센서 카드03 -->
                            <div class="dm-collapse-item mb-2">
                                <div class="dm-collapse-item__header" id="analyze-sensor-group-03">
                                    <a href="#"
                                       class="item-link analyze-sensor-wrapper broadcast-card"
                                       data-bs-toggle="collapse"
                                       data-bs-target="#collapse-body-c-3"
                                       aria-expanded="false"
                                       data-bs-parent="#broadcast-accordion-parent"
                                    >
                                        <div class="broadcast-card-content">
                                            <div class="broadcast-card-row broadcast-card-row-1">
                                            <span class="broadcast-card-status-stop">
                                                <i class="fas fa-volume-mute"></i> 중지중
                                            </span>
                                                <span class="broadcast-card-interval">
                                                <i class="las la-clock"></i> 0시간 05분 간격
                                            </span>
                                            </div>
                                            <div class="broadcast-card-row broadcast-card-row-2">
                                                <div>
                                                    <span class="broadcast-card-sensor-tag">
                                                        <span class="dot active"></span>
                                                        투입 1호
                                                    </span>
                                                    <span class="broadcast-card-sensor-tag">
                                                        <span class="dot active"></span>
                                                        휴대 2호
                                                    </span>
                                                    <span class="broadcast-card-sensor-tag">
                                                        <span class="dot active"></span>
                                                        휴대 4호
                                                    </span>
                                                </div>
                                                <i class="la la-angle-right"></i>
                                            </div>
                                            <div class="broadcast-card-row broadcast-card-row-3">
                                                <i class="las la-volume-down"></i>
                                                <p class="broadcast-card-message">
                                                    도움이 필요한 분 계십니까? 계시다면 소리가 나는 곳...
                                                </p>
                                            </div>
                                        </div>

                                    </a>
                                </div>

                                <div id="collapse-body-c-3" class="collapse dm-collapse-item__body">
                                    <div class="broadcast-card-controls">
                                        <button type="button" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-volume-mute"></i>
                                            <span>중단</span>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-edit"></i>
                                            <span>수정</span>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm btn-delete">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>삭제</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </section>

        <!-- 사운드 컨트롤러 팝업-->
        <div class="sound-controller">
            <div id="sensor-detail-popup">
                <div class="sensor-detail-wrapper">
                    <div class="">
                        <span class="sensor-status active"></span>
                        <span id="popup-sensor-name">센서 상세 정보</span>
                        <span id="popup-sensor-time">검출 시간</span>
                    </div>
                    <div class="sound-control-bar">
                        <div class="sound-button-group">
                            <div>
                                <button class="sound-control-button">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="sound-control-button">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                            <div class="divider"></div>
                            <div>
                                <button class="sound-control-button">
                                    <i class="fas fa-pause"></i>
                                </button>
                                <button class="sound-control-button">
                                    <i class="fas fa-retweet"></i>
                                </button>
                            </div>
                        </div>
                        <div class="sound-volume-control">
                            <i class="fas fa-volume-down"></i>
                            <input type="range" class="sound-control-slider" min="0" max="100" value="60" />
                        </div>
                    </div>
                </div>
                <img src="img/sound-wave.png" alt="" width="100%">
                <button id="popup-close-btn" aria-label="닫기">&times;</button>
            </div>
        </div>

        <script>
            (function() {
                // ===== broadcast.html 페이지 초기화 함수 =====
                function initBroadcastPage() {
                    console.log('방송 페이지 초기화 중...');

                    const broadcastAddBtn = document.querySelector('.broadcast-add-btn');

                    // 안전 장치: broadcast 페이지가 아니면 실행 중단
                    if (!broadcastAddBtn) {
                        console.log('방송 페이지가 아님');
                        return;
                    }

                    // ----- (A) 영구 요소 (페이지 밖에 있는 요소들) -----
                    const popupBox = document.getElementById('sensor-detail-popup');
                    const closeButton = document.getElementById('popup-close-btn');

                    // ----- (B) 페이지 내 동적 요소들 -----
                    const sensorCards = document.querySelectorAll('.sensor-modal-card');
                    const allIntervalGroups = document.querySelectorAll('.broadcast-modal-interval-group');
                    const allCheckboxes = document.querySelectorAll('.sensor-modal-card .checkbox');

                    // ----- (C) 모달 요소들 (body에 있음) -----
                    const basicModal = document.getElementById('modal-basic');
                    const confirmModal = document.getElementById('confirmModal');
                    const lastBroadcastModal = document.getElementById('lastBroadcastModal');

                    // ----- (D) 버튼 요소들 -----
                    const confirmBroadcastBtn = document.querySelector('#lastBroadcastModal .last-broadcast-btn-confirm');
                    const openConfirmBtn = document.getElementById('btn-open-confirm');
                    const backToConfigBtn = document.getElementById('confirm-btn-back');
                    const finalConfirmBtn = document.getElementById('confirm-btn-final');

                    // 모달 요소 존재 여부 확인
                    if (!basicModal || !confirmModal || !lastBroadcastModal) {
                        console.warn('모달 요소를 찾을 수 없습니다.');
                        return;
                    }

                    // 모달이 DOM에 연결되어 있는지 확인
                    if (!document.body.contains(basicModal) ||
                        !document.body.contains(confirmModal) ||
                        !document.body.contains(lastBroadcastModal)) {
                        console.warn('모달이 DOM에 제대로 연결되지 않았습니다.');
                        return;
                    }

                    // Bootstrap 모달 인스턴스 (필요할 때만 생성)
                    let basicModalInstance = null;
                    let confirmModalInstance = null;
                    let lastBroadcastModalInstance = null;

                    // 방송 설정 모달 인스턴스 가져오기/생성
                    function getBasicModalInstance() {
                        if (!basicModalInstance && basicModal && document.body.contains(basicModal)) {
                            try {
                                // 기존 인스턴스가 있으면 제거
                                const existingInstance = bootstrap.Modal.getInstance(basicModal);
                                if (existingInstance) {
                                    existingInstance.dispose();
                                }
                                // 새 인스턴스 생성
                                basicModalInstance = new bootstrap.Modal(basicModal, {
                                    backdrop: true,  // 백드롭 표시
                                    keyboard: true,  // ESC 키로 닫기 가능
                                    focus: true      // 모달에 자동 포커스
                                });
                            } catch (e) {
                                console.error('basicModal 초기화 실패:', e);
                                return null;
                            }
                        }
                        return basicModalInstance;
                    }

                    // 확인 모달 인스턴스 가져오기/생성
                    function getConfirmModalInstance() {
                        if (!confirmModalInstance && confirmModal && document.body.contains(confirmModal)) {
                            try {
                                const existingInstance = bootstrap.Modal.getInstance(confirmModal);
                                if (existingInstance) {
                                    existingInstance.dispose();
                                }
                                confirmModalInstance = new bootstrap.Modal(confirmModal, {
                                    backdrop: true,
                                    keyboard: true,
                                    focus: true
                                });
                            } catch (e) {
                                console.error('confirmModal 초기화 실패:', e);
                                return null;
                            }
                        }
                        return confirmModalInstance;
                    }

                    // 지난 방송 목록 모달 인스턴스 가져오기/생성
                    function getLastBroadcastModalInstance() {
                        if (!lastBroadcastModalInstance && lastBroadcastModal && document.body.contains(lastBroadcastModal)) {
                            try {
                                const existingInstance = bootstrap.Modal.getInstance(lastBroadcastModal);
                                if (existingInstance) {
                                    existingInstance.dispose();
                                }
                                lastBroadcastModalInstance = new bootstrap.Modal(lastBroadcastModal, {
                                    backdrop: true,
                                    keyboard: true,
                                    focus: true
                                });
                            } catch (e) {
                                console.error('lastBroadcastModal 초기화 실패:', e);
                                return null;
                            }
                        }
                        return lastBroadcastModalInstance;
                    }

                    // ----- 이벤트 리스너 등록 (중복 방지 플래그 사용) -----

                    // 1. 팝업 닫기 버튼
                    if (closeButton && !closeButton.dataset.listenerAttached) {
                        closeButton.addEventListener('click', function() {
                            popupBox.classList.remove('show');
                        });
                        closeButton.dataset.listenerAttached = 'true';
                    }

                    // 2. 방송데이터 추가 버튼 - 모달 열기
                    if (broadcastAddBtn && !broadcastAddBtn.dataset.modalListenerAttached) {
                        broadcastAddBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();

                            try {
                                const instance = getBasicModalInstance();
                                if (instance) {
                                    instance.show();
                                } else {
                                    console.error('모달 인스턴스를 생성할 수 없습니다.');
                                }
                            } catch (error) {
                                console.error('모달 열기 실패:', error);
                            }
                        });
                        broadcastAddBtn.dataset.modalListenerAttached = 'true';
                    }

                    // 3. 센서 카드 클릭 - 체크박스 토글
                    sensorCards.forEach(function(card) {
                        const checkbox = card.querySelector('.checkbox');
                        if (checkbox) {
                            // 초기 체크 상태를 active 클래스와 동기화
                            checkbox.checked = card.classList.contains('active');
                        }
                        if (!card.dataset.clickListenerAttached) {
                            card.addEventListener('click', function(event) {
                                // 체크박스 영역을 클릭한 경우는 제외 (중복 토글 방지)
                                if (!event.target.closest('.sensor-modal-checkmark')) {
                                    const checkbox = this.querySelector('.checkbox');
                                    if (checkbox) {
                                        checkbox.checked = !checkbox.checked;
                                        checkbox.dispatchEvent(new Event('change'));
                                    }
                                }
                            });
                            card.dataset.clickListenerAttached = 'true';
                        }
                    });

                    // 4. 체크박스 상태 변경 시 카드 active 클래스 토글
                    allCheckboxes.forEach(function(checkbox) {
                        if (!checkbox.dataset.changeListenerAttached) {
                            checkbox.addEventListener('change', function() {
                                const parentCard = this.closest('.sensor-modal-card');
                                if (parentCard) {
                                    parentCard.classList.toggle('active', this.checked);
                                }
                            });
                            checkbox.dataset.changeListenerAttached = 'true';
                        }
                    });

                    // 5. 체크박스 영역 클릭 시 이벤트 전파 중단 (카드 클릭과 충돌 방지)
                    document.querySelectorAll('.sensor-modal-checkmark').forEach(function(checkmarkArea) {
                        if (!checkmarkArea.dataset.clickListenerAttached) {
                            checkmarkArea.addEventListener('click', function(event) {
                                event.stopPropagation();
                            });
                            checkmarkArea.dataset.clickListenerAttached = 'true';
                        }
                    });

                    // 6. 방송 간격 버튼 클릭 - 하나만 active 상태 유지
                    allIntervalGroups.forEach(function(group) {
                        const allButtonsInGroup = group.querySelectorAll('.broadcast-modal-btn');
                        allButtonsInGroup.forEach(function(button) {
                            if (!button.dataset.clickListenerAttached) {
                                button.addEventListener('click', function() {
                                    // 같은 그룹의 다른 버튼들의 active 제거
                                    allButtonsInGroup.forEach(function(btn) {
                                        btn.classList.remove('active');
                                    });
                                    // 현재 버튼만 active
                                    this.classList.add('active');
                                });
                                button.dataset.clickListenerAttached = 'true';
                            }
                        });
                    });

                    // 7. 지난 방송 모달이 열릴 때 z-index 조정 (다른 모달 위에 표시)
                    if (lastBroadcastModal && !lastBroadcastModal.dataset.shownListenerAttached) {
                        lastBroadcastModal.addEventListener('shown.bs.modal', function () {
                            setTimeout(function() {
                                try {
                                    const firstModal = document.querySelector('#modal-basic');
                                    if (firstModal) {
                                        const firstModalZIndex = parseInt(window.getComputedStyle(firstModal).zIndex, 10);
                                        if (firstModalZIndex && !isNaN(firstModalZIndex)) {
                                            // 더 높은 z-index 설정
                                            lastBroadcastModal.style.zIndex = firstModalZIndex + 10;
                                            // 백드롭도 함께 조정
                                            const backdrops = document.querySelectorAll('.modal-backdrop');
                                            if (backdrops.length > 0) {
                                                backdrops[backdrops.length - 1].style.zIndex = firstModalZIndex + 9;
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.error("모달 z-index 설정 중 오류:", e);
                                }
                            }, 50);
                        });
                        lastBroadcastModal.dataset.shownListenerAttached = 'true';
                    }

                    // 8. 지난 방송 '확인' 버튼 - 선택한 메시지를 텍스트영역에 입력
                    if (confirmBroadcastBtn && !confirmBroadcastBtn.dataset.clickListenerAttached) {
                        confirmBroadcastBtn.addEventListener('click', function() {
                            // 선택된 라디오 버튼 찾기
                            const selectedRadio = document.querySelector('input[name="last-broadcast-radio"]:checked');
                            if (selectedRadio) {
                                const selectedLabel = selectedRadio.nextElementSibling;
                                const messageElement = selectedLabel.querySelector('.last-broadcast-col-message');
                                if (messageElement) {
                                    // 메시지 텍스트 추출 (아이콘 텍스트 제거)
                                    const messageText = messageElement.textContent.trim();
                                    const cleanMessage = messageText.replace(/^\s*/, '').replace(/^.*?\s/, '');

                                    // 방송 설정 모달의 텍스트영역에 입력
                                    const targetTextarea = document.querySelector('#modal-basic .sensor-modal-textarea');
                                    if (targetTextarea) {
                                        targetTextarea.value = cleanMessage;
                                    }

                                    // 지난 방송 모달 닫기
                                    const instance = getLastBroadcastModalInstance();
                                    if (instance) {
                                        instance.hide();
                                    }
                                }
                            } else {
                                alert("불러올 항목을 선택해주세요.");
                            }
                        });
                        confirmBroadcastBtn.dataset.clickListenerAttached = 'true';
                    }

                    // 9. 방송 설정 '확인' 버튼 - 확인 모달로 이동
                    if (openConfirmBtn && !openConfirmBtn.dataset.clickListenerAttached) {
                        openConfirmBtn.addEventListener('click', function() {
                            const confirmSensorList = document.getElementById('confirm-sensor-list');
                            if (!confirmSensorList) return;

                            // 확인 모달의 센서 목록 초기화
                            confirmSensorList.innerHTML = '';
                            let sensorCount = 0;

                            // 선택된 센서들을 확인 모달에 표시
                            document.querySelectorAll('.sensor-modal-card.active').forEach(function(card) {
                                const sensorName = card.querySelector('.sensor-name').textContent.trim();
                                sensorCount++;
                                const sensorItemHTML = `
                        <div class="col-3">
                            <button type="button" class="sensor-corfirm-modal-card active sensor-modal-available">
                                <div class="sensor-icon-wrapper">
                                    <div class="sensor-icon active">
                                        <img src="img/sensor_icon/portable_icon.png" alt="센서아이콘" class="sensor-custom-icon">
                                    </div>
                                </div>
                                <div class="">
                                    <div class="sensor-status-icons">
                                        <i class="fas fa-signal"></i>
                                        <i class="fas fa-wifi"></i>
                                        <span>75%</span>
                                    </div>
                                    <div class="sensor-modal-info-wrapper">
                                        <div class="sensor-details">
                                            <span class="sensor-name">${sensorName}</span>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                    `;
                                confirmSensorList.innerHTML += sensorItemHTML;
                            });

                            // 센서 미선택 시 경고
                            if (sensorCount === 0) {
                                alert('센서를 1개 이상 선택해주세요.');
                                return;
                            }

                            // 방송 간격 설정 확인 모달에 표시
                            let intervalText = '설정 안함';
                            const activeIntervalBtn = document.querySelector('.broadcast-modal-btn.active');
                            const confirmInterval = document.getElementById('confirm-broadcast-interval');
                            if (activeIntervalBtn && confirmInterval) {
                                if (activeIntervalBtn.classList.contains('broadcast-modal-direct-btn')) {
                                    // 직접설정인 경우
                                    const timeInputs = document.querySelectorAll('.broadcast-modal-time-inputs .broadcast-modal-time-input');
                                    const hour = timeInputs[0].value || 0;
                                    const min = timeInputs[1].value || 0;
                                    const sec = timeInputs[2].value || 0;
                                    intervalText = `${hour}시간 ${min}분 ${sec}초`;
                                } else {
                                    // 프리셋 버튼인 경우
                                    intervalText = activeIntervalBtn.textContent.trim();
                                }
                                confirmInterval.textContent = intervalText;
                            }

                            // 방송 메시지 확인 모달에 표시
                            const messageText = document.querySelector('.sensor-modal-textarea').value;
                            const confirmMessage = document.getElementById('confirm-broadcast-message');
                            if (confirmMessage) {
                                if (messageText) {
                                    confirmMessage.textContent = messageText;
                                } else {
                                    confirmMessage.textContent = '입력된 메시지가 없습니다.';
                                }
                            }

                            // 메시지 미입력 시 경고
                            if (!messageText) {
                                alert('방송 메세지를 입력해주세요.');
                                return;
                            }

                            // 방송 설정 모달 닫고 확인 모달 열기
                            const basicInstance = getBasicModalInstance();
                            if (basicInstance) {
                                basicInstance.hide();
                            }

                            setTimeout(function() {
                                const confirmInstance = getConfirmModalInstance();
                                if (confirmInstance) {
                                    confirmInstance.show();
                                }
                            }, 300);
                        });
                        openConfirmBtn.dataset.clickListenerAttached = 'true';
                    }

                    // 10. '다시 설정' 버튼 - 확인 모달에서 방송 설정 모달로 돌아가기
                    if (backToConfigBtn && !backToConfigBtn.dataset.clickListenerAttached) {
                        backToConfigBtn.addEventListener('click', function() {
                            const confirmInstance = getConfirmModalInstance();
                            if (confirmInstance) {
                                confirmInstance.hide();
                            }

                            setTimeout(function() {
                                const basicInstance = getBasicModalInstance();
                                if (basicInstance) {
                                    basicInstance.show();
                                }
                            }, 300);
                        });
                        backToConfigBtn.dataset.clickListenerAttached = 'true';
                    }

                    // 11. '최종 확인' 버튼 - 방송 목록에 추가
                    if (finalConfirmBtn && !finalConfirmBtn.dataset.clickListenerAttached) {
                        finalConfirmBtn.addEventListener('click', function() {
                            alert('새 방송이 목록에 추가되었습니다.');
                            const confirmInstance = getConfirmModalInstance();
                            if (confirmInstance) {
                                confirmInstance.hide();
                            }
                        });
                        finalConfirmBtn.dataset.clickListenerAttached = 'true';
                    }

                    console.log('방송 페이지 초기화 완료');
                }

                // ===== Bootstrap과 DOM이 완전히 준비될 때까지 대기 =====
                function checkBootstrapAndInit() {
                    if (typeof bootstrap !== 'undefined') {
                        // DOM 로딩 상태 확인
                        if (document.readyState === 'loading') {
                            // DOM이 아직 로딩 중이면 완료 후 초기화
                            document.addEventListener('DOMContentLoaded', function() {
                                setTimeout(initBroadcastPage, 200);
                            });
                        } else {
                            // DOM 로딩 완료 - 바로 초기화
                            setTimeout(initBroadcastPage, 200);
                        }
                    } else {
                        // Bootstrap이 아직 로드 안됨 - 50ms 후 재시도
                        setTimeout(checkBootstrapAndInit, 50);
                    }
                }

                // ===== 스크립트 실행 시작 =====
                console.log('방송 페이지 스크립트 시작...');
                checkBootstrapAndInit();
            })();
        </script>

<!--        <script src="assets/theme_assets/js/broadcast.js"></script>-->


    </div>

    @@include('./include/_footer.html')

</main>

<!--모달영역-->
<div class="modal-basic modal fade show" id="modal-basic" tabindex="-1" role="dialog" aria-hidden="true">

    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content modal-bg-white ">
            <div class="modal-header">
                <h6 class="modal-title">방송 설정 - 센서선택</h6>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <img src="img/svg/x.svg" alt="x" class="svg">
                </button>
            </div>
            <div class="modal-body sensor-modal-container">
                <section class="sensor-modal-section">
                    <div class="row g-3 sensor-modal-grid-wrapper">

                        <div class="col-3">
                            <button type="button" class="sensor-modal-card active sensor-modal-available">
                                <div class="sensor-icon-wrapper">
                                    <div class="sensor-icon active">
                                        <img src="img/sensor_icon/portable_icon.png" alt="센서아이콘" class="sensor-custom-icon">
                                    </div>
                                </div>
                                <div class="">
                                    <div class="sensor-status-icons">
                                        <i class="fas fa-signal"></i>
                                        <i class="fas fa-wifi"></i>
                                        <span>75%</span>
                                    </div>
                                    <div class="sensor-modal-info-wrapper">
                                        <div class="sensor-details">
                                            <span class="sensor-name">휴대용 센서 1호기</span>
                                        </div>
                                    </div>
                                    <span class="sensor-modal-checkmark">
                                            <div class="checkbox-theme-default custom-checkbox ">
                                                <input class="checkbox" type="checkbox" id="check-1">
                                                <label for="check-1" class="p-lg-0"></label>
                                            </div>
                                        </span>
                                </div>

                            </button>
                        </div>

                        <div class="col-3">
                            <button type="button" class="sensor-modal-card sensor-modal-available">
                                <div class="sensor-icon-wrapper">
                                    <div class="sensor-icon active">
                                        <img src="img/sensor_icon/portable_icon.png" alt="센서아이콘" class="sensor-custom-icon">
                                    </div>
                                </div>
                                <div class="">
                                    <div class="sensor-status-icons">
                                        <i class="fas fa-signal"></i>
                                        <i class="fas fa-wifi"></i>
                                        <span>75%</span>
                                    </div>
                                    <div class="sensor-modal-info-wrapper">
                                        <div class="sensor-details">
                                            <span class="sensor-name">휴대용 센서 2호기</span>
                                        </div>
                                    </div>
                                    <span class="sensor-modal-checkmark">
                                            <div class="checkbox-theme-default custom-checkbox ">
                                                <input class="checkbox" type="checkbox" id="check-2">
                                                <label for="check-2" class="p-lg-0"></label>
                                            </div>
                                        </span>
                                </div>

                            </button>
                        </div>

                        <div class="col-3">
                            <button type="button" class="sensor-modal-card sensor-modal-available">
                                <div class="sensor-icon-wrapper">
                                    <div class="sensor-icon active">
                                        <img src="img/sensor_icon/portable_icon.png" alt="센서아이콘" class="sensor-custom-icon">
                                    </div>
                                </div>
                                <div class="">
                                    <div class="sensor-status-icons">
                                        <i class="fas fa-signal"></i>
                                        <i class="fas fa-wifi"></i>
                                        <span>75%</span>
                                    </div>
                                    <div class="sensor-modal-info-wrapper">
                                        <div class="sensor-details">
                                            <span class="sensor-name">휴대용 센서 3호기</span>
                                        </div>
                                    </div>
                                    <span class="sensor-modal-checkmark">
                                            <div class="checkbox-theme-default custom-checkbox ">
                                                <input class="checkbox" type="checkbox" id="check-3">
                                                <label for="check-3" class="p-lg-0"></label>
                                            </div>
                                        </span>
                                </div>

                            </button>
                        </div>

                        <div class="col-3">
                            <button type="button" class="sensor-modal-card sensor-modal-available">
                                <div class="sensor-icon-wrapper">
                                    <div class="sensor-icon active">
                                        <img src="img/sensor_icon/portable_icon.png" alt="센서아이콘" class="sensor-custom-icon">
                                    </div>
                                </div>
                                <div class="">
                                    <div class="sensor-status-icons">
                                        <i class="fas fa-signal"></i>
                                        <i class="fas fa-wifi"></i>
                                        <span>75%</span>
                                    </div>
                                    <div class="sensor-modal-info-wrapper">
                                        <div class="sensor-details">
                                            <span class="sensor-name">휴대용 센서 4호기</span>
                                        </div>
                                    </div>
                                    <span class="sensor-modal-checkmark">
                                            <div class="checkbox-theme-default custom-checkbox ">
                                                <input class="checkbox" type="checkbox" id="check-4">
                                                <label for="check-4" class="p-lg-0"></label>
                                            </div>
                                        </span>
                                </div>
                            </button>
                        </div>

                        <div class="col-3">
                            <button type="button" class="sensor-modal-card sensor-modal-available">
                                <div class="sensor-icon-wrapper">
                                    <div class="sensor-icon active">
                                        <img src="img/sensor_icon/injection_icon.png" alt="센서아이콘" class="sensor-custom-icon">
                                    </div>
                                </div>
                                <div class="">
                                    <div class="sensor-status-icons">
                                        <i class="fas fa-signal"></i>
                                        <i class="fas fa-wifi"></i>
                                        <span>75%</span>
                                    </div>
                                    <div class="sensor-modal-info-wrapper">
                                        <div class="sensor-details">
                                            <span class="sensor-name">투입형 센서 1호기</span>
                                        </div>
                                    </div>
                                    <span class="sensor-modal-checkmark">
                                            <div class="checkbox-theme-default custom-checkbox ">
                                                <input class="checkbox" type="checkbox" id="check-5">
                                                <label for="check-5" class="p-lg-0"></label>
                                            </div>
                                        </span>
                                </div>
                            </button>
                        </div>

                        <div class="col-3">
                            <button type="button" class="sensor-modal-card sensor-modal-available">
                                <div class="sensor-icon-wrapper">
                                    <div class="sensor-icon active">
                                        <img src="img/sensor_icon/injection_icon.png" alt="센서아이콘" class="sensor-custom-icon">
                                    </div>
                                </div>
                                <div class="">
                                    <div class="sensor-status-icons">
                                        <i class="fas fa-signal"></i>
                                        <i class="fas fa-wifi"></i>
                                        <span>75%</span>
                                    </div>
                                    <div class="sensor-modal-info-wrapper">
                                        <div class="sensor-details">
                                            <span class="sensor-name">투입형 센서 2호기</span>
                                        </div>
                                    </div>
                                    <span class="sensor-modal-checkmark">
                                            <div class="checkbox-theme-default custom-checkbox ">
                                                <input class="checkbox" type="checkbox" id="check-6">
                                                <label for="check-6" class="p-lg-0"></label>
                                            </div>
                                        </span>
                                </div>
                            </button>
                        </div>

                        <div class="col-3">
                            <button type="button" class="sensor-modal-card sensor-modal-available">
                                <div class="sensor-icon-wrapper">
                                    <div class="sensor-icon active">
                                        <img src="img/sensor_icon/injection_icon.png" alt="센서아이콘" class="sensor-custom-icon">
                                    </div>
                                </div>
                                <div class="">
                                    <div class="sensor-status-icons">
                                        <i class="fas fa-signal"></i>
                                        <i class="fas fa-wifi"></i>
                                        <span>75%</span>
                                    </div>
                                    <div class="sensor-modal-info-wrapper">
                                        <div class="sensor-details">
                                            <span class="sensor-name">투입형 센서 3호기</span>
                                        </div>
                                    </div>
                                    <span class="sensor-modal-checkmark">
                                            <div class="checkbox-theme-default custom-checkbox ">
                                                <input class="checkbox" type="checkbox" id="check-7">
                                                <label for="check-7" class="p-lg-0"></label>
                                            </div>
                                        </span>
                                </div>
                            </button>
                        </div>

                        <div class="col-3">
                            <button type="button" class="sensor-modal-card sensor-modal-available">
                                <div class="sensor-icon-wrapper">
                                    <div class="sensor-icon active">
                                        <img src="img/sensor_icon/injection_icon.png" alt="센서아이콘" class="sensor-custom-icon">
                                    </div>
                                </div>
                                <div class="">
                                    <div class="sensor-status-icons">
                                        <i class="fas fa-signal"></i>
                                        <i class="fas fa-wifi"></i>
                                        <span>75%</span>
                                    </div>
                                    <div class="sensor-modal-info-wrapper">
                                        <div class="sensor-details">
                                            <span class="sensor-name">투입형 센서 4호기</span>
                                        </div>
                                    </div>
                                    <span class="sensor-modal-checkmark">
                                            <div class="checkbox-theme-default custom-checkbox ">
                                                <input class="checkbox" type="checkbox" id="check-8">
                                                <label for="check-8" class="p-lg-0"></label>
                                            </div>
                                        </span>
                                </div>
                            </button>
                        </div>
                    </div>
                </section>

                <section class="broadcast-modal-section">
                    <h6 class="broadcast-modal-title">방송간격 설정</h6>

                    <div class="broadcast-modal-interval-group">

                        <div class="broadcast-modal-btn-group" role="group">
                            <button type="button" class="broadcast-modal-btn active">10초</button>
                            <button type="button" class="broadcast-modal-btn">30초</button>
                            <button type="button" class="broadcast-modal-btn">1분</button>
                        </div>

                        <div class="broadcast-modal-direct-input-row">
                            <button type="button" class="broadcast-modal-btn broadcast-modal-direct-btn">
                                직접설정
                            </button>
                            <div class="broadcast-modal-time-inputs">
                                <input type="number" class="broadcast-modal-time-input" value="0">
                                <span class="broadcast-modal-time-label">시간</span>
                                <input type="number" class="broadcast-modal-time-input" value="0">
                                <span class="broadcast-modal-time-label">분</span>
                                <input type="number" class="broadcast-modal-time-input" value="0">
                                <span class="broadcast-modal-time-label">초</span>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="sensor-modal-section">
                    <div class="sensor-modal-message-header">
                        <h6 class="sensor-modal-title">방송메세지 설정</h6>
                        <a href="#"
                           class="sensor-modal-load-btn"
                           data-bs-toggle="modal"
                           data-bs-target="#lastBroadcastModal">
                            <i class="las la-history"></i>
                            지난 방송 불러오기
                        </a>
                    </div>
                    <textarea class="form-control sensor-modal-textarea" rows="4" placeholder="방송 메세지를 입력하세요."></textarea>
                </section>

            </div>
            <div class="broadcast-modal-footer">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">
                    취소
                </button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-open-confirm">
                    확인
                </button>
            </div>
        </div>
    </div>
</div>

<!--지난 방송 모달-->
<div class="modal fade last-broadcast-modal-wrapper"
     id="lastBroadcastModal"
     tabindex="-1"
     aria-labelledby="lastBroadcastModalLabel"
     aria-hidden="true">

    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="last-broadcast-header">
                <div class="last-broadcast-title-group">
                    <h5 class="last-broadcast-title" id="lastBroadcastModalLabel">
                        지난 방송목록
                    </h5>
                    <p class="last-broadcast-subtitle">
                        지난 방송목록중에 불러올 데이터를 선택해주세요.
                    </p>
                </div>
                <div class="last-broadcast-header-right">
                    <select class="last-broadcast-select">
                        <option>최신순</option>
                        <option>오래된순</option>
                    </select>
                    <button type="button" class="last-broadcast-close-btn" data-bs-dismiss="modal" aria-label="Close">
                        &times;
                    </button>
                </div>
            </div>

            <div class="last-broadcast-body">
                <div class="last-broadcast-list-container">

                    <input type="radio" name="last-broadcast-radio" class="last-broadcast-radio-input" id="item-1">
                    <label class="last-broadcast-item" for="item-1">
                        <span class="last-broadcast-radio-custom"></span>
                        <div class="last-broadcast-col-time">
                            2025년 11월 12일 오후 1시 30분
                        </div>
                        <div class="last-broadcast-col-duration">
                            <i class="las la-retweet"></i> 1분 30초
                        </div>
                        <div class="last-broadcast-col-message">
                            <i class="las la-volume-up"></i> 생존자가 있으면 소리를 질러주세요.
                        </div>
                    </label>

                    <input type="radio" name="last-broadcast-radio" class="last-broadcast-radio-input" id="item-2" checked>
                    <label class="last-broadcast-item" for="item-2">
                        <span class="last-broadcast-radio-custom"></span>
                        <div class="last-broadcast-col-time">
                            2025년 11월 12일 오후 1시 30분
                        </div>
                        <div class="last-broadcast-col-duration">
                            <i class="las la-retweet"></i> 1분 30초
                        </div>
                        <div class="last-broadcast-col-message">
                            <i class="las la-volume-up"></i> 방송이 들리면 소리를 내주세요.
                        </div>
                    </label>

                    <input type="radio" name="last-broadcast-radio" class="last-broadcast-radio-input" id="item-3">
                    <label class="last-broadcast-item" for="item-3">
                        <span class="last-broadcast-radio-custom"></span>
                        <div class="last-broadcast-col-time">
                            2025년 11월 12일 오후 1시 30분
                        </div>
                        <div class="last-broadcast-col-duration">
                            <i class="las la-retweet"></i> 1분 30초
                        </div>
                        <div class="last-broadcast-col-message">
                            <i class="las la-volume-up"></i> 생존자가 있으면 소리를 질러주세요.
                        </div>
                    </label>

                    <input type="radio" name="last-broadcast-radio" class="last-broadcast-radio-input" id="item-4">
                    <label class="last-broadcast-item" for="item-4">
                        <span class="last-broadcast-radio-custom"></span>
                        <div class="last-broadcast-col-time">
                            2025년 11월 12일 오후 1시 30분
                        </div>
                        <div class="last-broadcast-col-duration">
                            <i class="las la-retweet"></i> 1분 30초
                        </div>
                        <div class="last-broadcast-col-message">
                            <i class="las la-volume-up"></i> 생존자가 있으면 소리를 질러주세요.
                        </div>
                    </label>

                    <input type="radio" name="last-broadcast-radio" class="last-broadcast-radio-input" id="item-5">
                    <label class="last-broadcast-item" for="item-5">
                        <span class="last-broadcast-radio-custom"></span>
                        <div class="last-broadcast-col-time">
                            2025년 11월 12일 오후 1시 30분
                        </div>
                        <div class="last-broadcast-col-duration">
                            <i class="las la-retweet"></i> 1분 30초
                        </div>
                        <div class="last-broadcast-col-message">
                            <i class="las la-volume-up"></i> 생존자가 있으면 소리를 질러주세요.
                        </div>
                    </label>

                </div>
            </div>

            <div class="last-broadcast-footer">
                <button type="button" class="last-broadcast-btn last-broadcast-btn-cancel" data-bs-dismiss="modal">
                    취소
                </button>
                <button type="button" class="last-broadcast-btn last-broadcast-btn-confirm">
                    확인
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 데이터 확인 모달-->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content confirm-modal-content">

            <div class="confirm-modal-header">
                <i class="las la-bell confirm-modal-icon"></i>
                <h5 class="confirm-modal-title" id="confirmModalLabel">
                    설정한 센서와 시간을 확인해주세요.
                </h5>
            </div>

            <div class="modal-body confirm-modal-body">
                <div class="confirm-modal-section">
                    <h6>센서</h6>
                    <div id="confirm-sensor-list" class="confirm-sensor-list">
                    </div>
                </div>

                <div class="confirm-modal-section">
                    <h6>방송간격</h6>
                    <p id="confirm-broadcast-interval"></p>
                </div>

                <div class="confirm-modal-section">
                    <h6>방송메세지</h6>
                    <p id="confirm-broadcast-message"></p>
                </div>
            </div>

            <div class="modal-footer confirm-modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="confirm-btn-back">
                    다시설정
                </button>
                <button type="button" class="btn btn-primary" id="confirm-btn-final">
                    확인
                </button>
            </div>
        </div>
    </div>
</div>

@@include('./include/_scripts.html')

</body>

</html>