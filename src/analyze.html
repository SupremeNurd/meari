@@include('./include/_head.html')

<body class="layout-light side-menu">

@@include('./include/_header_menu.html')

<main class="main-content">

    @@include('./include/_sidebar_menu.html')

    <div class="dashboard-container" id="app-content">

        <section class="dashboard-section section-map">
            <img src="img/meari-map.jpg" alt="메아리 지도">
        </section>

        <section class="dashboard-section section-list">
            <div class="sensor-list-container">

                <header class="sensor-list-header">
                    <h6>검출된 신호</h6>
                    <div>
                        <div class="dropdown dropdown-fixed">
                            <a href="#"
                               class="text-decoration-none text-dark"
                               data-bs-toggle="dropdown"
                               aria-expanded="false"
                               data-bs-auto-close="outside"
                            >
                                <i class="fas fa-calendar-alt calendar-popup"></i>
                            </a>

                            <div class="dropdown-menu dropdown-menu--dynamic dropdown-menu-end calender-wrapper">
                                <h5>2025년 12월</h5>
                                <p class="small text-muted mb-2">
                                    파란색 날짜는 음성신호가 검출된 날짜입니다.
                                </p>
                                <div>
                                    <div class="date-picker">
                                        <div class="date-picker__calendar"></div>
                                    </div>
                                </div>

                                <div class="checkbox-theme-default custom-checkbox ">
                                    <input class="checkbox" type="checkbox" id="check-1">
                                    <label for="check-1">
                                        <span class="checkbox-text">오늘 데이터만 보기</span>
                                    </label>
                                </div>
                                <div class="d-flex justify-content-end mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="dropdown">
                                        취소
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary ms-2" data-bs-dismiss="dropdown">
                                        확인
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="dropdown dropdown-fixed">
                            <a href="#"
                               class="text-decoration-none text-dark"
                               data-bs-toggle="dropdown"
                               aria-expanded="false"
                               data-bs-auto-close="outside" >
                                <i class="fas fa-sliders-h filtering-popup"></i>
                            </a>

                            <!-- 필터링 설정 팝업-->
                            <div class="dropdown-menu dropdown-menu--dynamic dropdown-menu-end calender-wrapper">
                                <div class="filtering-title">
                                    <h5>필터링 설정</h5>
                                    <button type="button" class="filtering-reset-btn">
                                        초기화
                                    </button>
                                </div>
                                <p class="filtering-sub-title">
                                    시간설정
                                </p>
                                <div class="filtering-time-wrapper">
                                    <div class="filtering-time-input">
                                        <input type="number" value="0" min="0" max="23" class="filtering-time-value"> 시
                                        <input type="number" value="0" min="0" max="59" class="filtering-time-value"> 분
                                        <input type="number" value="0" min="0" max="59" class="filtering-time-value"> 초
                                    </div>
                                    <span>~</span>
                                    <div class="filtering-time-input">
                                        <input type="number" value="0" min="0" max="23" class="filtering-time-value"> 시
                                        <input type="number" value="0" min="0" max="59" class="filtering-time-value"> 분
                                        <input type="number" value="0" min="0" max="59" class="filtering-time-value"> 초
                                    </div>
                                </div>

                                <p class="filtering-sub-title">
                                    센서 설정
                                </p>
                                <div class="row g-2 filtering-sensor-grid">
                                    <div class="col-3">
                                        <button type="button" class="filtering-sensor-btn active">
                                            <div class="filtering-sensor-icon">
                                                <div class="sensor-icon active">
                                                    <img src="img/sensor_icon/portable_icon.png" alt="Injection Icon" class="sensor-custom-icon">
                                                </div>
                                            </div>
                                            <span class="filtering-sensor-name">휴대용 1호기</span>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="filtering-sensor-btn">
                                            <div class="filtering-sensor-icon">
                                                <div class="sensor-icon active">
                                                    <img src="img/sensor_icon/portable_icon.png" alt="Injection Icon" class="sensor-custom-icon">
                                                </div>
                                            </div>
                                            <span class="filtering-sensor-name">휴대용 2호기</span>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="filtering-sensor-btn">
                                            <div class="filtering-sensor-icon">
                                                <div class="sensor-icon active">
                                                    <img src="img/sensor_icon/portable_icon.png" alt="Injection Icon" class="sensor-custom-icon">
                                                </div>
                                            </div>
                                            <span class="filtering-sensor-name">휴대용 3호기</span>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="filtering-sensor-btn">
                                            <div class="filtering-sensor-icon">
                                                <div class="sensor-icon active">
                                                    <img src="img/sensor_icon/portable_icon.png" alt="Injection Icon" class="sensor-custom-icon">
                                                </div>
                                            </div>
                                            <span class="filtering-sensor-name">휴대용 4호기</span>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="filtering-sensor-btn">
                                            <div class="filtering-sensor-icon">
                                                <div class="sensor-icon active">
                                                    <img src="img/sensor_icon/injection_icon.png" alt="Injection Icon" class="sensor-custom-icon">
                                                </div>
                                            </div>
                                            <span class="filtering-sensor-name">투입형 1호기</span>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="filtering-sensor-btn">
                                            <div class="filtering-sensor-icon">
                                                <div class="sensor-icon active">
                                                    <img src="img/sensor_icon/injection_icon.png" alt="Injection Icon" class="sensor-custom-icon">
                                                </div>
                                            </div>
                                            <span class="filtering-sensor-name">투입형 2호기</span>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="filtering-sensor-btn">
                                            <div class="filtering-sensor-icon">
                                                <div class="sensor-icon active">
                                                    <img src="img/sensor_icon/injection_icon.png" alt="Injection Icon" class="sensor-custom-icon">
                                                </div>
                                            </div>
                                            <span class="filtering-sensor-name">투입형 3호기</span>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="filtering-sensor-btn">
                                            <div class="filtering-sensor-icon">
                                                <div class="sensor-icon active">
                                                    <img src="img/sensor_icon/injection_icon.png" alt="Injection Icon" class="sensor-custom-icon">
                                                </div>
                                            </div>
                                            <span class="filtering-sensor-name">투입형 4호기</span>
                                        </button>
                                    </div>
                                </div>

                                <p class="small text-muted mb-2 mt-3">신호 필터링</p>
                                <div class="filtering-signal-wrapper">
                                    <div class="filtering-signal-icon-btn">
                                        <img src="img/sensor_icon/animal.png" alt="animal Icon" class="filtering-signal-icon">
                                    </div>
                                    <div class="filtering-signal-icon-btn">
                                        <img src="img/sensor_icon/cough.png" alt="Cough Icon" class="filtering-signal-icon">
                                    </div>
                                    <div class="filtering-signal-icon-btn">
                                        <img src="img/sensor_icon/danger.png" alt="Cough Icon" class="filtering-signal-icon">
                                    </div>
                                    <div class="filtering-signal-icon-btn">
                                        <img src="img/sensor_icon/moan.png" alt="Cough Icon" class="filtering-signal-icon">
                                    </div>
                                    <div class="filtering-signal-icon-btn">
                                        <img src="img/sensor_icon/shout.png" alt="Cough Icon" class="filtering-signal-icon">
                                    </div>
                                    <div class="filtering-signal-icon-btn">
                                        <img src="img/sensor_icon/sos.png" alt="Cough Icon" class="filtering-signal-icon">
                                    </div>
                                    <div class="filtering-signal-icon-btn">
                                        <img src="img/sensor_icon/whistle.png" alt="Cough Icon" class="filtering-signal-icon">
                                    </div>
                                    <div class="filtering-signal-icon-btn">
                                        <img src="img/sensor_icon/none.png" alt="Cough Icon" class="filtering-signal-icon">
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="dropdown">
                                        취소
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary ms-2" data-bs-dismiss="dropdown">
                                        확인
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </header>
                <div class="analyze-sensor-time-range">
                    <p>2025-10-23 14:02:25 ~ 2025-10-23 14:02:25</p>
                </div>

                <div class="sensor-list-body">
                    <div class="dm-collapse dm-collapse-custom">

                        <div class="dm-collapse-item mb-2">
                            <div class="dm-collapse-item__header " id="analyze-sensor-group-01">
                                <a href="#" class="item-link analyze-sensor-wrapper" data-bs-toggle="collapse" data-bs-target="#collapse-body-c-1" aria-expanded="false">
                                    <div class="analyze-sensor-info-top">
                                        <div class="analyze-sensor-details">
                                            <span class="sensor-status active"></span>
                                            <span class="sensor-name">
                                                휴대용 센서 1호기
                                            </span>
                                        </div>
                                        <div class="analyze-time-group">
                                            <p class="analyze-sensor-name">
                                                2025-10-23 14:02:25
                                            </p>
                                            <div class="analyze-sensor-activity-icons">
                                                <div class="analyze-activity-icon">
                                                    <img src="img/sensor_icon/cough.png" alt="Cough Icon" class="activity-custom-icon">
                                                </div>
                                                <div class="analyze-activity-icon">
                                                    <img src="img/sensor_icon/animal.png" alt="Animal Icon" class="activity-custom-icon">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <i class="la la-angle-right"></i>
                                </a>
                            </div>
                            <div id="collapse-body-c-1" class="collapse dm-collapse-item__body">
                                <div class="analyze-data-list">
                                    <p class="analyze-sensor-time">
                                        2025-10-23 14:02:25
                                    </p>
                                    <img src="img/sensor_icon/cough.png" alt="Cough Icon" class="activity-custom-icon">
                                    <p class="analyze-sensor-section">
                                        10초
                                    </p>
                                </div>
                                <div class="analyze-data-list">
                                    <p class="analyze-sensor-time">
                                        2025-10-23 14:02:35
                                    </p>
                                    <img src="img/sensor_icon/cough.png" alt="Cough Icon" class="activity-custom-icon">
                                    <p class="analyze-sensor-section">
                                        25초
                                    </p>
                                </div>
                                <div class="analyze-data-list">
                                    <p class="analyze-sensor-time">
                                        2025-10-23 14:02:45
                                    </p>
                                    <img src="img/sensor_icon/cough.png" alt="Cough Icon" class="activity-custom-icon">
                                    <p class="analyze-sensor-section">
                                        17초
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="dm-collapse-item mb-2">
                            <div class="dm-collapse-item__header" id="analyze-sensor-group-02">
                                <a href="#" class="item-link analyze-sensor-wrapper" data-bs-toggle="collapse" data-bs-target="#collapse-body-c-2" aria-expanded="false">
                                    <div class="analyze-sensor-info-top">
                                        <div class="analyze-sensor-details">
                                            <span class="sensor-status active"></span>
                                            <span class="sensor-name">
                                                휴대용 센서 2호기
                                            </span>
                                        </div>
                                        <div class="analyze-time-group">
                                            <p class="analyze-sensor-name">
                                                2025-10-23 14:02:25
                                            </p>
                                            <div class="analyze-sensor-activity-icons">
                                                <div class="analyze-activity-icon">
                                                    <img src="img/sensor_icon/cough.png" alt="Cough Icon" class="activity-custom-icon">
                                                </div>
                                                <div class="analyze-activity-icon">
                                                    <img src="img/sensor_icon/animal.png" alt="Animal Icon" class="activity-custom-icon">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <i class="la la-angle-right"></i>
                                </a>
                            </div>
                            <div id="collapse-body-c-2" class="collapse dm-collapse-item__body">
                                <div class="analyze-data-list">
                                    <p class="analyze-sensor-time">
                                        2025-10-23 14:02:25
                                    </p>
                                    <img src="img/sensor_icon/cough.png" alt="Cough Icon" class="activity-custom-icon">
                                    <p class="analyze-sensor-section">
                                        10초
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="dm-collapse-item mb-2">
                            <div class="dm-collapse-item__header" id="analyze-sensor-group-03">
                                <a href="#" class="item-link analyze-sensor-wrapper"
                                   data-bs-toggle="collapse"
                                   data-bs-target="#collapse-body-c-3" aria-expanded="false">
                                    <div class="analyze-sensor-info-top">
                                        <div class="analyze-sensor-details">
                                            <span class="sensor-status active"></span>
                                            <span class="sensor-name">
                                                휴대용 센서 3호기
                                            </span>
                                        </div>
                                        <div class="analyze-time-group">
                                            <p class="analyze-sensor-name">
                                                2025-10-23 14:02:25
                                            </p>
                                            <div class="analyze-sensor-activity-icons">
                                                <div class="analyze-activity-icon">
                                                    <img src="img/sensor_icon/cough.png" alt="Cough Icon" class="activity-custom-icon">
                                                </div>
                                                <div class="analyze-activity-icon">
                                                    <img src="img/sensor_icon/animal.png" alt="Animal Icon" class="activity-custom-icon">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <i class="la la-angle-right"></i>
                                </a>
                            </div>
                            <div id="collapse-body-c-3" class="collapse dm-collapse-item__body">
                                <div class="analyze-data-list">
                                    <p class="analyze-sensor-time">
                                        2025-10-25 14:02:25
                                    </p>
                                    <img src="img/sensor_icon/cough.png" alt="Cough Icon" class="activity-custom-icon">
                                    <p class="analyze-sensor-section">
                                        10초
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </section>

        <div class="sound-controller">
            <div id="sensor-detail-popup">
                <div class="sensor-detail-wrapper">
                    <div class="">
                        <span class="sensor-status active"></span>
                        <span id="popup-sensor-name">센서 상세 정보</span>
                        <span id="popup-sensor-time">검출 시간</span>
                    </div>
                    <div class="sound-control-bar">
                        <div class="sound-button-group">
                            <div>
                                <button class="sound-control-button">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="sound-control-button">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                            <div class="divider"></div>
                            <div>
                                <button class="sound-control-button">
                                    <i class="fas fa-pause"></i>
                                </button>
                                <button class="sound-control-button">
                                    <i class="fas fa-retweet"></i>
                                </button>
                            </div>
                        </div>
                        <div class="sound-volume-control">
                            <i class="fas fa-volume-down"></i>
                            <input type="range" class="sound-control-slider" min="0" max="100" value="60" />
                        </div>
                    </div>
                </div>
                <img src="img/sound-wave.png" alt="" width="100%">
                <button id="popup-close-btn" aria-label="닫기">&times;</button>
            </div>
        </div>

        <script>
            (function() {
                // ===== analyze.html 페이지 초기화 함수 =====
                function initAnalyzePage() {
                    console.log('분석 페이지 초기화 중...');

                    // ----- (A) 영구 요소 (페이지 밖에 있는 요소들) -----
                    const popupBox = document.getElementById('sensor-detail-popup');
                    const closeButton = document.getElementById('popup-close-btn');
                    const popupSensorName = document.getElementById('popup-sensor-name');
                    const popupSensorTime = document.getElementById('popup-sensor-time');

                    // ----- (B) 동적 요소 (현재 페이지 내 요소들) -----
                    const fixedDropdownElements = document.querySelectorAll('.dropdown-fixed');
                    const headerDropdownToggles = document.querySelectorAll('.sensor-list-header .dropdown [data-bs-toggle="dropdown"]');
                    const dataListItems = document.querySelectorAll('.analyze-data-list');
                    const dismissButtons = document.querySelectorAll('[data-bs-dismiss="dropdown"]');

                    // 안전 장치: analyze 페이지가 아니면 실행 중단
                    if (!dataListItems || dataListItems.length === 0) {
                        console.log('분석 페이지가 아님');
                        return;
                    }

                    // ----- (C) 이벤트 리스너 및 컴포넌트 초기화 -----

                    // 1. 팝업 닫기 버튼
                    if (closeButton) {
                        closeButton.addEventListener('click', function() {
                            popupBox.classList.remove('show');
                        });
                    }

                    // 2. 드롭다운을 고정 위치로 설정 (화면 밖으로 나가지 않도록)
                    fixedDropdownElements.forEach(function(element) {
                        const toggleButton = element.querySelector('[data-bs-toggle="dropdown"]');
                        if (typeof bootstrap !== 'undefined' && toggleButton) {
                            new bootstrap.Dropdown(toggleButton, {
                                popperConfig: {
                                    strategy: 'fixed' // 뷰포트 기준 고정 위치
                                }
                            });
                        }
                    });

                    // 3. 헤더의 여러 드롭다운 중 하나만 열리도록 상호 배제
                    headerDropdownToggles.forEach(function(currentToggle) {
                        currentToggle.addEventListener('show.bs.dropdown', function(event) {
                            // 다른 드롭다운들은 모두 닫기
                            headerDropdownToggles.forEach(function(otherToggle) {
                                if (otherToggle !== event.target) {
                                    const dropdownInstance = bootstrap.Dropdown.getInstance(otherToggle);
                                    if (dropdownInstance) {
                                        dropdownInstance.hide();
                                    }
                                }
                            });
                        });
                    });

                    // 4. 드롭다운 내부의 "취소", "확인" 버튼 클릭 시 드롭다운 닫기
                    dismissButtons.forEach(function(dismissButton) {
                        dismissButton.addEventListener('click', function(event) {
                            // 가장 가까운 드롭다운 요소 찾기
                            let dropdownWrapper = this.closest('.dropdown');
                            if (dropdownWrapper) {
                                let toggleButton = dropdownWrapper.querySelector('[data-bs-toggle="dropdown"]');
                                if (toggleButton) {
                                    let dropdownInstance = bootstrap.Dropdown.getInstance(toggleButton);
                                    if (dropdownInstance) {
                                        dropdownInstance.hide();
                                    }
                                }
                            }
                        });
                    });

                    // 5. 분석 데이터 리스트 클릭 시 팝업 열기
                    dataListItems.forEach(function(item) {
                        item.addEventListener('click', function() {
                            // 센서명 가져오기
                            const collapseItem = this.closest('.dm-collapse-item');
                            let sensorName = "센서 상세 정보";
                            if (collapseItem) {
                                const nameEl = collapseItem.querySelector('.sensor-name');
                                if (nameEl) {
                                    sensorName = nameEl.textContent.trim();
                                }
                            }
                            if (popupSensorName) {
                                popupSensorName.textContent = sensorName;
                            }

                            // 검출 시간 가져오기
                            let sensorTime = "시간 정보 없음";
                            const timeElement = this.querySelector('.analyze-sensor-time');
                            if (timeElement) {
                                sensorTime = timeElement.textContent.trim();
                            }
                            if (popupSensorTime) {
                                popupSensorTime.textContent = sensorTime;
                            }

                            // 팝업 표시
                            if (popupBox) {
                                popupBox.classList.add('show');
                            }
                        });
                    });

                    // 6. 달력(Datepicker) 초기화 - jQuery UI 사용
                    const datePickerElement = document.querySelector('.date-picker .date-picker__calendar');

                    if (datePickerElement && typeof $ !== 'undefined' && $.fn.datepicker) {
                        try {
                            // 기존 datepicker 인스턴스 제거 (재초기화 방지)
                            $(datePickerElement).datepicker('destroy');

                            // jQuery UI Datepicker 초기화
                            $(datePickerElement).datepicker({
                                inline: true,                    // 인라인으로 표시
                                showOtherMonths: true,           // 다른 달 날짜 표시
                                selectOtherMonths: true,         // 다른 달 날짜 선택 가능
                                dateFormat: 'yy-mm-dd',          // 날짜 형식
                                // 한글 텍스트 설정
                                monthNames: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                                monthNamesShort: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                                dayNames: ['일', '월', '화', '수', '목', '금', '토'],
                                dayNamesShort: ['일', '월', '화', '수', '목', '금', '토'],
                                dayNamesMin: ['일', '월', '화', '수', '목', '금', '토'],
                                // 날짜 선택 시 콜백
                                onSelect: function(dateText, inst) {
                                    console.log('선택된 날짜:', dateText);
                                }
                            });

                            console.log('jQuery UI Datepicker 초기화 성공');
                        } catch (error) {
                            console.error('Datepicker 초기화 오류:', error);
                            datePickerElement.innerHTML = '<p class="text-danger small p-2">달력 초기화 실패</p>';
                        }
                    } else if (datePickerElement) {
                        // jQuery 또는 datepicker 플러그인이 없는 경우
                        console.warn('jQuery 또는 datepicker 플러그인을 찾을 수 없습니다.');
                        console.log('jQuery:', typeof $);
                        console.log('$.fn.datepicker:', typeof $ !== 'undefined' && $.fn
                            ? typeof $.fn.datepicker
                            : 'undefined'
                        );
                    }

                    console.log('분석 페이지 초기화 완료');
                }

                // ===== 라이브러리 로딩 대기 및 초기화 실행 =====
                function checkLibrariesAndRun(retryCount = 0) {
                    const maxRetries = 60; // 최대 3초 대기 (50ms × 60)

                    // Bootstrap, jQuery, datepicker가 모두 로드되었는지 확인
                    if (typeof bootstrap !== 'undefined' && typeof $ !== 'undefined' && $.fn && $.fn.datepicker) {
                        console.log('모든 라이브러리 로드 완료 (Bootstrap + jQuery + Datepicker)');
                        initAnalyzePage();
                    } else if (retryCount < maxRetries) {
                        // 아직 로드 안됨 - 50ms 후 재시도
                        setTimeout(function() {
                            checkLibrariesAndRun(retryCount + 1);
                        }, 50);
                    } else {
                        // 타임아웃 - 로드 실패
                        console.error('라이브러리 로드 타임아웃');
                        console.log('Bootstrap:', typeof bootstrap);
                        console.log('jQuery:', typeof $);
                        console.log('$.fn.datepicker:', typeof $ !== 'undefined' && $.fn
                            ? typeof $.fn.datepicker
                            : 'undefined'
                        );

                        // 그래도 초기화 시도 (부분적으로라도 작동하도록)
                        initAnalyzePage();
                    }
                }

                // ===== 스크립트 실행 시작 =====
                console.log('분석 페이지 스크립트 시작...');
                checkLibrariesAndRun();

            })();
        </script>

    </div>

    @@include('./include/_footer.html')

</main>

@@include('./include/_scripts.html')

</body>

</html>